name: Update Scores

on:
  schedule:
    - cron: "*/5 * * * *"  # every 5 minutes
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout scoreboard repo
        uses: actions/checkout@v4

      - name: Generate token scoped to all flag repos
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: flag-1,flag-2,flag-3,flag-4,flag-5,flag-6,flag-7

      - name: Collect solves from flag repos
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ORG: ${{ github.repository_owner }}
        run: |
          # Build scores.json from issues in flag-1 through flag-7.
          # Each issue body must contain a line: user: <username>
          # Issues without that line are ignored.

          players='{}'

          for i in 1 2 3 4 5 6 7; do
            gh issue list \
              --repo "$ORG/flag-$i" \
              --state all \
              --json body,createdAt \
              --limit 1000 \
            | jq -r '.[] | [.createdAt, (.body | split("\n")[] | select(test("^user:")) | ltrimstr("user:") | ltrimstr(" ") | rtrimstr(" "))] | @tsv' \
            | while IFS=$'\t' read -r created username; do
                [ -z "$username" ] && continue
                echo "$i $created $username"
              done
          done \
          | jq -Rs '
            split("\n") | map(select(length > 0)) |
            map(split(" ") | {cid: .[0]|tonumber, created: .[1], user: .[2]}) |
            group_by(.user) |
            map({
              username: .[0].user,
              solved: (map(.cid) | unique | sort),
              first_solve: (map(.created) | sort | .[0])
            }) |
            {updated_at: now | todate, players: .}
          ' > scores.json

          echo "Participants: $(jq '.players | length' scores.json)"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
